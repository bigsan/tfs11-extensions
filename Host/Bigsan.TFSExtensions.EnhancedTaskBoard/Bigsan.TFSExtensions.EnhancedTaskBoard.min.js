define(["require","exports","Presentation/Scripts/TFS/TFS","Presentation/Scripts/TFS/TFS.Core","Presentation/Scripts/TFS/TFS.Host","Presentation/Scripts/TFS/TFS.OM","Presentation/TestScripts/Resources/TFS.Resources.Common","Presentation/Scripts/TFS/TFS.UI.Controls","Presentation/Scripts/TFS/TFS.UI.Controls.Menus"],function(n,t,i,r,u,f,e,o,s){function l(n){console.log(n)}function b(){var n='<style id="etb" type="text/css">.daysAgo { float: left; padding: 0 4px; color: white; background: darkgreen; line-height: 18px; }.daysAgo.recent { background: darkred; }.tbPivotItem .daysAgo { margin-right: 4px; }.tbPivotItem .witRemainingWork { float: left; margin-right: 4px; }.tbPivotItem .pivot-state { line-height: 18px; font-weight: bold; border: dotted 1px gray; background: #ddd; padding: 0 2px; }.tbPivotItem .ellipsis { float: left; }.tbPivotItem .ellipsis + .daysAgo { margin: 1px 4px 0 4px; }.pivot-state.approved, .pivot-state.new { background: red; color: white; }.pivot-state.done { background: dardgreen; color: white; }.wiid { margin-right: 4px; font-size: 80%; text-decoration: underline; }.daysAgo + .witTitle > .wiid { margin-left: 4px; }.tile-dimmed { opacity: 0.2; }.tbTileContent.recent-1day { border-left-color: rgb(160, 215, 149); }<\/style>';$("head").append(n)}function nt(){var n=TFS.getModuleBase("Bigsan.TFSExtensions.EnhancedTaskBoard")+"amplify-1.1.0.min.js";$("head").append($("<script>").attr({type:"text/javascript",src:n}))}function k(n){var u=$("#tile-"+n),t=u,f=TFS.Host.history.getCurrentState().action||"stories",i,r;f=="stories"&&(i=$("#taskboard-table_p"+n),r=i.closest(".taskboard-row").next(),t=t.add(i).add(r)),t.each(function(t,i){$(i).find(".wiid").length==0&&$(i).find(".witTitle").prepend("<strong class='wiid' />"),$(i).find(".witTitle .wiid").text(n)})}function v(n,t){var s=TFS.Host.history.getCurrentState().action||"stories",h=(new Date).getTime()-t.changedDate.getTime(),u=h/864e5,i=$("<div class='daysAgo'>"+u.toFixed(1)+"d<\/div>").attr("title","Last Changed: "+t.changedDate.toLocaleString()),f,r,e,o;u<2&&i.addClass("recent"),u<=1&&i.addClass("recent-1day"),f=$("#tile-"+n),f.find(".daysAgo").remove(),f.find(".witExtra").prepend(i.clone()),u<=1&&f.find(".tbTileContent").addClass("recent recent-1day"),r=$("#taskboard-table_p"+n),r.length>0&&s=="stories"&&(e=r.closest(".taskboard-row").next(),r.find(".daysAgo, .pivot-state").remove(),e.find(".daysAgo, .pivot-state").remove(),o=$("<span class='pivot-state'>"+t.state+"<\/span>").addClass(t.state.toLowerCase()),r.find(".tbPivotItem .witRemainingWork").before(i.clone()).after(o.clone()),e.find(".tbPivotItem").append(i.clone()).append(o.clone()))}function tt(){$(".hub-pivot-content").css("top","+=40px"),$("<div class='toolbar hub-pivot-toolbar'><\/div>").insertAfter($(".hub-pivot")),o.BaseControl.createIn(s.MenuBar,$(".hub-pivot-toolbar"),{items:[{id:"expandAll",text:a.ExpandAll,title:a.ExpandAllToolTip,showText:!1,icon:"icon-tree-expand-all"},{id:"collapseAll",text:a.CollapseAll,title:a.CollapseAllToolTip,showText:!1,icon:"icon-tree-collapse-all"},{id:"refresh",text:"Refresh",title:"Refresh",showText:!1,icon:"icon-refresh"}],executeAction:function(n){var t=n.get_commandName();switch(t){case"expandAll":$(".taskboard-row-summary::visible").each(function(n,t){$(t).prev().find(".taskboard-expander").click()});break;case"collapseAll":$(".taskboard-row-summary:not(:visible)").each(function(n,t){$(t).prev().find(".taskboard-expander").click()});break;case"refresh":TFS.Host.ActionManager.performAction(TFS.Host.CommonActions.ACTION_WINDOW_RELOAD)}}})}function it(){return $(".tbTile, .taskboard-parent[id]").map(function(n,t){return t.id.match(/\d+$/)[0]}).get()}function rt(n,t){h.beginGetWorkItems(n,function(n){t(n)})}function d(){var n,t;l("queryWorkItems start."),n=it(),$.each(n,function(n,t){return k(t)}),t=TFS.globalProgressIndicator.actionStarted("queryWorkItem"),rt(n,function(n){$.each(n,function(n,t){var i=t.getFieldValue("System.Id"),r=t.getFieldValue("System.State"),u=t.getFieldValue("System.ChangedDate").value;v(i,{changedDate:u,state:r})}),TFS.globalProgressIndicator.actionCompleted(t),l("queryWorkItems end.")})}function ut(n,t){var i='<div class="select pivot-filter enhance" title="{title}"><span class="title">{title}<\/span><ul class="pivot-filter-items"><li class="pivot-filter-item" data-value="on" title="ON"><a href="#">ON<\/a><\/li><li class="pivot-filter-item" data-value="off" title="OFF"><a href="#">OFF<\/a><\/li><\/ul><\/div>';return t!="on"&&(t="off"),$(i).attr("title",n).find(".title").text(n).end().find("li[data-value="+t+"]").addClass("selected").end().prependTo($(".filters:first"))}function g(n){var t=$(".header-section"),i=$(".content-section");n?(t.animate({"margin-top":"-91px"}),i.animate({top:0})):(t.animate({"margin-top":0}),i.animate({top:"91px"})),(c=="backlogs.index"||c=="backlogs.iteration")&&$.queue($(".content-section")[0],"fx",function(){$(".productbacklog-grid-results").resize(),$.dequeue(this)})}function ft(n,t){h.beginGetWorkItem(n,function(n){var u=n.getLinks(),i=null,r;$.each(u,function(n,t){if(t.baseLinkType=="WorkItemLink"&&t.getLinkTypeEnd().name=="Parent")return i=t,!1}),r=i.getTargetId(),h.beginGetWorkItem(r,function(n){t(n)})})}var h=TFS.OM.TfsTeamProjectCollection.getDefaultConnection().getService(TFS.WorkItemTracking.WorkItemStore).workItemManager,a=e,w=TFS.Host.TfsContext.getDefault().navigation,c=(w.currentController+"."+w.currentAction).toLowerCase(),y,p;l("_currentRoute: "+c),nt(),y=amplify.store("maxWorkspace"),p=ut("maximize workspace",y?"on":"off"),o.Enhancement.ensureEnhancements(p),p.bind("changed",function(n,t){var i=t.value=="on";g(i),amplify.store("maxWorkspace",i)}),g(y),$("#taskboard").delegate(".tbTile","mousemove",function(n){var t=$("#parentPBIHint"),i,r;t.length==0&&(t=$("<div id='parentPBIHint'/>").css({position:"absolute",width:"126px",background:"#eee",padding:"2px 8px",borderRadius:"0 5px 5px 0",border:"1px solid brown",borderWidth:"1px 1px 1px 6px",borderColor:"black black black brown"}).appendTo("body")),i=$(this),r=i.attr("id").match(/-(\d+)/)[1],ft(r,function(n){var u=n.id+": "+n.getTitle(),r;t.text(u),r=i.offset(),r.left+=6,r.top-=t.height()-1,t.offset(r).show()}),n.stopPropagation()}).delegate(".taskboard-cell","mousemove",function(){$("#parentPBIHint").hide()}).scroll(function(){$("#parentPBIHint").hide()}),c=="boards.index"?(b(),tt(),h.attachWorkItemChanged(function(n,t){if(t.change=="reset"||t.change=="save-completed"){var i=t.workItem,r=i.getFieldValue("System.Id"),u=i.getFieldValue("System.State"),f=i.getFieldValue("System.ChangedDate").value;window.setTimeout(function(){k(r),v(r,{changedDate:f,state:u})},100)}}),TFS.Host.history.attachNavigate("stories",function(){d(),l("onNaviage: stories")},!0),TFS.Host.history.attachNavigate("team",function(){l("onNavigate: team")},!0),d()):c=="backlogs.board"&&(b(),h.attachWorkItemChanged(function(n,t){if(t.change=="reset"||t.change=="save-completed"){var i=t.workItem,r=i.getFieldValue("System.Id"),u=i.getFieldValue("System.State"),f=i.getFieldValue("System.ChangedDate").value;window.setTimeout(function(){var n=$(".board-tile[data-item-id="+r+"]");$(n).find(".wiid").length==0&&$(n).find(".title").prepend("<strong class='wiid' />"),$(n).find(".title .wiid").text($(n).data("itemId")),v(r,{changedDate:f,state:u})},100)}}),window.setTimeout(function(){$(".board-tile").each(function(n,t){$(t).find(".wiid").length==0&&$(t).find(".title").prepend("<strong class='wiid' />"),$(t).find(".title .wiid").text($(t).data("itemId"))})},100))})