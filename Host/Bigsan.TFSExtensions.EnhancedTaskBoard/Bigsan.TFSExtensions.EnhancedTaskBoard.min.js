TFS.module("Bigsan.TFSExtensions.EnhancedTaskBoard",["TFS.Host"],function(){function u(){var n='<style id="etb" type="text/css">.daysAgo { float: left; padding: 0 4px; color: white; background: darkgreen; }.daysAgo.recent { background: darkred; }.wiid { margin-right: 4px; }.task-board-summary .tbPivotItem .ellipsis { float: left; }.tbPivotItem .pivot-state { font-size: 120%; font-weight: bold; }<\/style>';$("head").append(n)}function t(n){var i=$("#tile-"+n),t=$("#taskboard-table_p"+n),r=t.closest(".taskboard-row").next();i.add(t).add(r).each(function(t,i){$(i).find(".wiid").length==0&&$(i).find(".witTitle").prepend("<strong class='wiid' />"),$(i).find(".witTitle .wiid").text(n)})}function f(n){$.each(n,function(n,i){t(i)})}function i(n,t){var f=(new Date).getTime()-t.changedDate.getTime(),r=Math.ceil(f/864e5),i=$("<div class='daysAgo'>"+r+"d<\/div>").attr("title",t.changedDate.toString());r<2&&i.addClass("recent"),$("#tile-"+n).find(".daysAgo").remove().end().find(".witExtra").prepend(i);var u=$("#taskboard-table_p"+n),e=u.closest(".taskboard-row").next(),o=u.add(e);o.find(".daysAgo").remove().end().find(".witTitle").before(i).end().find(".pivot-state").remove().end().find(".tbPivotItem").append("<span class='pivot-state'>"+t.state+"<\/span>")}function e(){return $(".tbTile, .taskboard-parent[id]").map(function(n,t){return t.id.match(/\d+$/)[0]}).get()}function o(t,i){n.beginGetWorkItems(t,function(n){i(n)})}var n=TFS.OM.TfsTeamProjectCollection.getDefault().getService(TFS.WorkItemTracking.WorkItemStore).workItemManager,r=e();o(r,function(n){var t=new Date;$.each(n,function(n,t){var r=t.getFieldValue("System.Id"),u=t.getFieldValue("System.State"),f=t.getFieldValue("System.ChangedDate").value;i(r,{changedDate:f,state:u})})}),u(),f(r),n.attachWorkItemChanged(function(n,r){if(r.change=="reset"||r.change=="save-completed"){var u=r.workItem,f=u.getFieldValue("System.Id"),e=u.getFieldValue("System.State"),o=u.getFieldValue("System.ChangedDate").value;window.setTimeout(function(){t(f),i(f,{changedDate:o,state:e})},500)}})})