TFS.module("Bigsan.TFSExtensions.EnhancedTaskBoard",["TFS.Host"],function(){function e(){var n='<style id="etb" type="text/css">.daysAgo { float: left; padding: 0 4px; color: white; background: darkgreen; }.daysAgo.recent { background: darkred; }.taskboard-parent-wrapper .daysAgo { padding: 2px 4px 3px; }.wiid { margin-right: 4px; }.daysAgo + .witTitle > .wiid { margin-left: 4px; }.taskboard-row-summary .tbPivotItem .ellipsis { float: left; }.taskboard-row-summary .tbPivotItem .pivot-state { margin-left: 4px; }.tbPivotItem .pivot-state { font-size: 120%; font-weight: bold; line-height: 25px; }.tile-dimmed { opacity: 0.2; }<\/style>';$("head").append(n)}function r(n){var u=$("#tile-"+n),t=u,f=TFS.Host.history.getCurrentState().action,i,r;f=="stories"&&(i=$("#taskboard-table_p"+n),r=i.closest(".taskboard-row").next(),t=t.add(i).add(r)),t.each(function(t,i){$(i).find(".wiid").length==0&&$(i).find(".witTitle").prepend("<strong class='wiid' />"),$(i).find(".witTitle .wiid").text(n)})}function u(n,t){var f=TFS.Host.history.getCurrentState().action,e=(new Date).getTime()-t.changedDate.getTime(),r=Math.round(e/864e5),i=$("<div class='daysAgo'>"+r+"d<\/div>").attr("title","Last Changed: "+t.changedDate.toLocaleString());if(r<2&&i.addClass("recent"),$("#tile-"+n).find(".daysAgo").remove().end().find(".witExtra").prepend(i),f=="stories"){var u=$("#taskboard-table_p"+n),o=u.closest(".taskboard-row").next(),s=u.add(o);s.find(".daysAgo").remove().end().find(".witTitle").before(i).end().find(".pivot-state").remove().end().find(".tbPivotItem").append("<span class='pivot-state'>"+t.state+"<\/span>")}}function o(){$(".hub-pivot-content").css("top","+=40px"),$("<div class='toolbar hub-pivot-toolbar'><\/div>").insertAfter($(".hub-pivot")),TFS.UI.Controls.Menus.MenuBar.createIn($(".hub-pivot-toolbar"),{items:[{id:"expandAll",text:n.ExpandAll,title:n.ExpandAllToolTip,showText:!1,icon:"icon-tree-expand-all"},{id:"collapseAll",text:n.CollapseAll,title:n.CollapseAllToolTip,showText:!1,icon:"icon-tree-collapse-all"}],executeAction:function(n){var t=n.get_commandName();switch(t){case"expandAll":$(".taskboard-row-summary::visible").each(function(n,t){$(t).prev().find(".taskboard-expander").click()});break;case"collapseAll":$(".taskboard-row-summary:not(:visible)").each(function(n,t){$(t).prev().find(".taskboard-expander").click()})}}})}function s(n){var t='<div class="select pivot-filter enhance" title="{title}"><span class="title">{title}<\/span><ul class="pivot-filter-items"><li class="pivot-filter-item" data-value="on" title="ON"><a href="#">ON<\/a><\/li><li class="pivot-filter-item selected" data-value="off" title="OFF"><a href="#">OFF<\/a><\/li><\/ul><\/div>';return $(t).attr("title",n).find(".title").text(n).end().prependTo($(".filters:first"))}function h(n){n?($(".header-section").animate({"margin-top":"-=91px"}),$(".content-section").animate({top:"-=91px"})):($(".header-section").animate({"margin-top":"+=91px"}),$(".content-section").animate({top:"+=91px"}))}function c(){return $(".tbTile, .taskboard-parent[id]").map(function(n,t){return t.id.match(/\d+$/)[0]}).get()}function l(n,t){i.beginGetWorkItems(n,function(n){t(n)})}function f(){console.log("initQuery");var n=c();l(n,function(n){$.each(n,function(n,t){var i=t.getFieldValue("System.Id"),f=t.getFieldValue("System.State"),e=t.getFieldValue("System.ChangedDate").value;r(i),u(i,{changedDate:e,state:f})})})}var i=TFS.OM.TfsTeamProjectCollection.getDefault().getService(TFS.WorkItemTracking.WorkItemStore).workItemManager,n=TFS.Resources.Common,t;e(),o(),t=s("maximize workspace"),TFS.Host.UI.PivotFilter.ensureEnhancements(t),t.bind("changed",function(n,t){var i=t.value=="on";h(i)}),i.attachWorkItemChanged(function(n,t){if(t.change=="reset"||t.change=="save-completed"){var i=t.workItem,f=i.getFieldValue("System.Id"),e=i.getFieldValue("System.State"),o=i.getFieldValue("System.ChangedDate").value;window.setTimeout(function(){r(f),u(f,{changedDate:o,state:e})},500)}}),TFS.Host.history.attachNavigate("stories",function(){f(),console.log("onNaviage: stories")},!0),TFS.Host.history.attachNavigate("team",function(){console.log("onNavigate: team")},!0),f()})